<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chaudhary Construction Invoice</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
  /* A4 sizing at 96dpi */
  :root { --a4w: 794px; --a4h: 1123px; }

  body{ font-family: Arial, Helvetica, sans-serif; background:#f4f4f4; margin:16px; }

  /* Editor */
  .editor{ background:#fff; border:1px solid #ddd; border-radius:10px; padding:14px; margin:0 auto 16px; max-width:var(--a4w); }
  .editor h3{ margin:0 0 10px; font-size:16px; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .grid label{ display:block; font-weight:600; font-size:13px; margin-bottom:4px; }
  .grid input,.grid textarea{ width:100%; box-sizing:border-box; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:13px; }
  .row-actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  .btn{ background:#0b74ff; color:#fff; border:0; padding:9px 12px; border-radius:8px; cursor:pointer; }
  .btn.secondary{ background:#666; }
  .btn.danger{ background:#c62828; padding:4px 8px; border-radius:6px; font-size:12px; }

  /* Page (simple border – no shadows that cause dark fringes) */
  #page{
    width:var(--a4w);
    min-height: var(--a4h);
    margin:0 auto;
    background:#fff;
    box-sizing:border-box;
    padding:14px;
    position:relative;
    overflow:hidden;
    border:3px solid #000; /* crisp outer line, not a shadow */
  }

  /* Invoice box */
  #invoice{ background:#fff; color:#000; border:1px solid #000; padding:18px 16px; box-sizing:border-box; }

  h2{ text-align:center; margin:2px 0; font-size:26px; }
  h4{ text-align:center; margin:2px 0; font-size:12px; font-weight:600; }
  .subtitle{ font-weight:700; text-align:center; margin:0 0 6px; }
  .gstin{ text-align:center; margin:0 0 8px; }

  table{ width:100%; border-collapse:collapse; font-size:13px; }
  table, th, td{ border:1px solid #000; }
  th, td{ padding:6px; vertical-align:top; }

  .kv{ display:grid; grid-template-columns:130px 1fr; gap:4px 8px; }
  .kv .k{ font-weight:700; }
  .kv .v{ white-space:pre-line; }

  /* Items (inputs) */
  #itemsTable td input{
    width:100%; box-sizing:border-box; padding:6px;
    border:1px solid #bdbdbd; border-radius:6px; font-size:13px;
  }
  #itemsTable td input[readonly]{ background:#f7f7f7; }

  /* Keep Action column visible on phones: sticky + horizontal scroll wrapper */
  .table-wrap{ overflow-x:auto; }
  th.actions-col, td.actions-col{
    position: sticky; right: 0;
    background:#fff; z-index: 2; /* stays on top while scrolling */
    min-width: 84px;
  }
  th.actions-col{ z-index:3; } /* header above cells */

  /* Totals */
  .totals .tax-input{ border:none; outline:none; background:transparent; width:60px; text-align:center; font-weight:bold; }
  .tax-pct-text{ display:none; }

  /* Simple boxed sections (no grey) */
  .box{ border:1px solid #000; background:#fff; padding:10px 12px; margin-top:10px; }

  /* Bank details */
  .bank-box .row{ display:flex; gap:24px; flex-wrap:wrap; }
  .bank-box b{ font-weight:700; }

  /* T&C + Signature single outer box (no inner divider) */
  .footer-box{ border:1px solid #000; background:#fff; padding:10px 12px; margin-top:10px; }
  .footer-flex{ display:flex; align-items:center; gap:16px; }
  .footer-flex .tc{ flex:1; }
  .footer-flex .sig{ flex:0 0 35%; text-align:right; }

  .sign-name{ font-weight:700; }
  .sign-title{ font-size:12px; }
  .sign-img{ display:inline-block; width:160px; height:auto; margin:6px 0 2px; user-select:none; pointer-events:none; }

  /* Buttons container */
  #actions{ display:flex; gap:10px; justify-content:center; margin:12px auto; max-width:var(--a4w); }

  /* Mobile */
  @media (max-width: 640px){
    :root { --a4w: 100%; }
    body{ margin:8px; }
    #page{ width:100%; padding:8px; }
    .editor, #invoice{ width:100%; }
    table, th, td{ font-size:11px; }
    .btn{ font-size:13px; padding:7px 10px; }
    .footer-flex{ flex-direction:column; align-items:stretch; }
    .footer-flex .sig{ text-align:center; flex-basis:auto; }
    .sign-img{ width:130px; }
  }

  /* Print/PDF rules */
  @media print{
    body{ background:#fff; margin:0; }
    .editor, #actions{ display:none !important; }
    .totals .tax-input{ display:none !important; }
    .tax-pct-text{ display:inline !important; }
    .no-print{ display:none !important; }
  }
</style>
</head>
<body>

<!-- ====== EDITOR ====== -->
<div class="editor" id="editor">
  <h3>Edit Details</h3>
  <div class="grid">
    <div><label>Party Name</label><input id="in_partyName" placeholder="Please enter Party Name"></div>
    <div><label>Party GSTIN</label><input id="in_partyGST" placeholder="Please enter GSTIN"></div>
    <div style="grid-column:1/-1">
      <label>Party Address (multiline)</label>
      <textarea id="in_partyAddress" rows="3" placeholder="Please enter Address (multi-line)"></textarea>
    </div>

    <div><label>Invoice No.</label><input id="in_invoiceNo" placeholder="Please enter Invoice No."></div>
    <div><label>Invoice Date (dd/mm/yyyy)</label><input id="in_invoiceDate" placeholder="Please enter Invoice Date"></div>
    <div><label>Work Order No.</label><input id="in_workOrder" placeholder="Please enter Work Order No."></div>
    <div><label>Dispatch Through</label><input id="in_dispatch" placeholder="Please enter Dispatch Through"></div>
    <div><label>Vehicle No.</label><input id="in_vehicle" placeholder="Please enter Vehicle No."></div>
    <div><label>Place of Supply</label><input id="in_place" placeholder="Please enter Place of Supply"></div>
  </div>

  <div class="row-actions">
    <button class="btn" id="applyBtn" type="button">Apply to Preview</button>
    <button class="btn secondary" id="addRowBtn" type="button">+ Add Item Row</button>
  </div>
</div>

<!-- ====== PAGE (captured to PDF) ====== -->
<div id="page">
  <div id="invoice">
    <h4>INVOICE ISSUED UNDER RULE -7 AND SECTION 28</h4>
    <h2>CHAUDHARY CONSTRUCTION</h2>
    <div class="subtitle">Add: Vill. Madhubani, P.O.Dumaria (Estate), W.Champaran, Bihar, 845103</div>
    <div class="gstin">GSTIN : 10CDAPC5190C1ZF</div>

    <!-- Party + Invoice info -->
    <table>
      <tr>
        <td style="width:40%">
          <strong>Party’s Details / Bill To</strong><br><br>
          <div class="kv">
            <div class="k">Name :</div>     <div class="v" id="partyNameText"></div>
            <div class="k">Address :</div>  <div class="v" id="partyAddressText"></div>
            <div class="k">GSTIN No. :</div><div class="v" id="partyGSTText"></div>
          </div>
        </td>
        <td style="width:40%">
          <div class="kv">
            <div class="k">Invoice No. :</div>     <div class="v" id="invoiceNoText"></div>
            <div class="k">Invoice Date :</div>    <div class="v" id="invoiceDateText"></div>
            <div class="k">Work Order No. :</div>  <div class="v" id="workOrderText"></div>
            <div class="k">Dispatch Through :</div><div class="v" id="dispatchText"></div>
            <div class="k">Vehicle No. :</div>     <div class="v" id="vehicleText"></div>
            <div class="k">Place of Supply :</div> <div class="v" id="placeText"></div>
          </div>
        </td>
      </tr>
    </table>

    <!-- Items (scrollable on small screens so Action stays visible) -->
    <br/>
    <div class="table-wrap">
      <table id="itemsTable">
        <thead>
          <tr>
            <th style="width:50px;text-align:center">Sr</th>
            <th>Description of Goods</th>
            <th style="width:90px;text-align:center">SAC</th>
            <th style="width:70px;text-align:center">Qty</th>
            <th style="width:110px;text-align:center">Rate (₹)</th>
            <th style="width:80px;text-align:center">UOM</th>
            <th style="width:130px;text-align:center">Amount (₹)</th>
            <th class="actions-col" id="actionHeader">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Totals -->
    <br/>
    <table class="totals">
      <tr>
        <td><b>Total Amount Before Tax</b></td>
        <td style="width:230px"><span id="totalBeforeTaxText">₹ 0.00</span></td>
      </tr>
      <tr>
        <td>
          <b>Add: SGST @</b>
          <input id="sgst" type="number" value="0" class="tax-input" oninput="calculateTotals()"> %
          <span class="tax-pct-text" id="sgstPctPDF">0 %</span>
        </td>
        <td><span id="sgstAmt">₹ 0.00</span></td>
      </tr>
      <tr>
        <td>
          <b>Add: CGST @</b>
          <input id="cgst" type="number" value="0" class="tax-input" oninput="calculateTotals()"> %
          <span class="tax-pct-text" id="cgstPctPDF">0 %</span>
        </td>
        <td><span id="cgstAmt">₹ 0.00</span></td>
      </tr>
      <tr>
        <td>
          <b>Add: IGST @</b>
          <input id="igst" type="number" value="18" class="tax-input" oninput="calculateTotals()"> %
          <span class="tax-pct-text" id="igstPctPDF">18 %</span>
        </td>
        <td><span id="igstAmt">₹ 0.00</span></td>
      </tr>
      <tr>
        <td><b>Total Invoice Value (₹)</b></td>
        <td><span id="totalInvoiceValueText">₹ 0.00</span></td>
      </tr>
    </table>

    <div class="box bank-box">
        <p><b>Rs. (in Words):</b> <span id="amountInWords">Zero Only</span></p>
    </div>
    <!-- BANK DETAILS (boxed, no shadow) -->
    <div class="box bank-box">
      <div style="font-weight:700; margin-bottom:6px;">BANK DETAILS:</div>
      <div class="">
        <div><b>Bank Account No.:</b> 39930691999</div>
        <br>
        <div><b>IFSC Code:</b> SBIN0000718</div>
      </div>
    </div>

    <!-- T&C + Signature in one outer box (no internal divider) -->
    <div class="footer-box">
      <div class="footer-flex">
        <div class="tc">
          <div style="font-weight:700; margin-bottom:6px;">Terms & Conditions.</div>
          <ol style="margin:0 0 0 18px; padding:0;">
            <li>Goods once sold will not be taken back.</li>
            <li>All disputes subject to Bihar Jurisdiction only.</li>
          </ol>
        </div>
        <div class="sig">
          <div>For <span class="sign-name">AMIT KUMAR</span></div>
          <img id="signImg" class="sign-img" src="data:image/jpeg;base64,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" alt="Signature" /><br>
          <div class="sign-title">Authorized Signatory</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Buttons -->
<div id="actions">
  <button class="btn" id="generateBtn" type="button">Generate PDF</button>
</div>

<script>
  /* ---------- Items ---------- */
  const tbody = document.querySelector("#itemsTable tbody");
  let sr = 0;
  function addRow(){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:center">${++sr}</td>
      <td><input class="desc" placeholder="Enter description"></td>
      <td><input class="sac" placeholder="SAC"></td>
      <td><input class="qty"  type="number" value="1" min="0"></td>
      <td><input class="rate" type="number" value="0" min="0" step="0.01"></td>
      <td><input class="uom" type="number" value="0" min="0" step="0.01"></td>
      <td><input class="amount" readonly></td>
      <td class="actions-col"><button class="btn danger" type="button" onclick="delRow(this)">Delete</button></td>`;
    tbody.appendChild(tr);
  }
  function delRow(btn){
    btn.closest("tr").remove();
    sr = 0; document.querySelectorAll("#itemsTable tbody tr").forEach(r=>r.children[0].textContent=++sr);
    calculateTotals();
  }
  addRow();
  document.getElementById("addRowBtn").addEventListener("click", addRow);

  /* ---------- Editor -> Preview ---------- */
  function applyToPreview(){
    const v = id => document.getElementById(id).value || "";
    const setText = (id, text) => document.getElementById(id).textContent = text;
    const setHTML = (id, html) => document.getElementById(id).innerHTML = (html||"").replace(/\n/g,"<br>");

    setText("partyNameText", v("in_partyName"));
    setHTML("partyAddressText", v("in_partyAddress"));
    setText("partyGSTText", v("in_partyGST"));

    setText("invoiceNoText", v("in_invoiceNo"));
    setText("invoiceDateText", v("in_invoiceDate"));
    setText("workOrderText", v("in_workOrder"));
    setText("dispatchText", v("in_dispatch"));
    setText("vehicleText", v("in_vehicle"));
    setText("placeText", v("in_place"));
  }
  document.getElementById("applyBtn").addEventListener("click", applyToPreview);
  applyToPreview();

  /* ---------- Totals / GST ---------- */
  function calculateTotals(){
    let total = 0;
    document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
      const qty  = parseFloat(r.querySelector(".qty")?.value)||0;
      const rate = parseFloat(r.querySelector(".rate")?.value)||0;
      const amt  = qty*rate;
      const amountInput = r.querySelector(".amount");
      if(amountInput) amountInput.value = amt ? amt.toFixed(2) : "";
      total += amt;
    });

    const sgstEl = document.getElementById("sgst");
    const cgstEl = document.getElementById("cgst");
    const igstEl = document.getElementById("igst");

    const sgst = parseFloat(sgstEl.value) || 0;
    const cgst = parseFloat(cgstEl.value) || 0;
    const igst = parseFloat(igstEl.value) || 0;

    const sgstAmt = total*sgst/100;
    const cgstAmt = total*cgst/100;
    const igstAmt = total*igst/100;
    const grand   = total + sgstAmt + cgstAmt + igstAmt;

    document.getElementById("totalBeforeTaxText").textContent   = "₹ " + total.toFixed(2);
    document.getElementById("sgstAmt").textContent              = "₹ " + sgstAmt.toFixed(2);
    document.getElementById("cgstAmt").textContent              = "₹ " + cgstAmt.toFixed(2);
    document.getElementById("igstAmt").textContent              = "₹ " + igstAmt.toFixed(2);
    document.getElementById("totalInvoiceValueText").textContent= "₹ " + grand.toFixed(2);
    document.getElementById("amountInWords").textContent        = toWords(Math.round(grand)) + " Only";

    // Mirror % text for PDF (when inputs hidden)
    document.getElementById("sgstPctPDF").textContent = (sgstEl.value || 0) + " %";
    document.getElementById("cgstPctPDF").textContent = (cgstEl.value || 0) + " %";
    document.getElementById("igstPctPDF").textContent = (igstEl.value || 0) + " %";
  }
  function toWords(num){
    const a=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
    const b=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
    if((num=num.toString()).length>9) return "Overflow";
    let n=("000000000"+num).slice(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
    if(!n) return "Zero";
    let s="";
    s+=n[1]!=0?(a[+n[1]]||b[n[1][0]]+" "+a[n[1][1]])+" Crore ":"";
    s+=n[2]!=0?(a[+n[2]]||b[n[2][0]]+" "+a[n[2][1]])+" Lakh ":"";
    s+=n[3]!=0?(a[+n[3]]||b[n[3][0]]+" "+a[n[3][1]])+" Thousand ":"";
    s+=n[4]!=0?(a[+n[4]]||b[n[4][0]]+" "+a[n[4][1]])+" Hundred ":"";
    s+=n[5]!=0?((s!=="")?"and ":"")+(a[+n[5]]||b[n[5][0]]+" "+a[n[5][1]]):"";
    return s.trim();
  }
  tbody.addEventListener("input", calculateTotals);
  calculateTotals();

  /* ---------- PDF: A4 Clone (no black edges, identical everywhere) ---------- */
  document.getElementById("generateBtn").addEventListener("click", async () => {
    applyToPreview();
    calculateTotals();

    // Clone the A4 page off-screen
    const original = document.getElementById("page");
    const clone = original.cloneNode(true);

    const holder = document.createElement("div");
    holder.style.position = "fixed";
    holder.style.left = "-10000px";
    holder.style.top = "0";
    holder.style.width = "var(--a4w)";
    holder.style.height = "auto";
    holder.style.zIndex = "-1";
    document.body.appendChild(holder);

    // Force exact A4 px on clone and remove outer border for capture (avoids dark fringes)
    clone.style.width = "794px";
    clone.style.minHeight = "1123px";
    clone.style.border = "none";       // no outer border on the clone
    clone.style.background = "#fff";

    // Convert item inputs to plain text only in clone
    clone.querySelectorAll("#itemsTable tbody tr").forEach(tr => {
      tr.querySelectorAll("input").forEach(inp => {
        const td = inp.parentElement;
        td.textContent = (inp.value || "").trim();
      });
    });

    // Hide Action column in the clone
    const ch = clone.querySelector("#actionHeader");
    if (ch) ch.style.display = "none";
    clone.querySelectorAll("#itemsTable tbody .actions-col").forEach(td => td.style.display = "none");

    // Hide tax inputs; show mirrored % text
    clone.querySelectorAll(".totals .tax-input").forEach(i => i.style.display = "none");
    clone.querySelectorAll(".tax-pct-text").forEach(s => s.style.display = "inline");

    // Remove editor/actions if present in clone (safety)
    const ce = clone.querySelector("#editor"); if (ce) ce.remove();
    const ca = clone.querySelector("#actions"); if (ca) ca.remove();

    holder.appendChild(clone);

    // Ensure images loaded in clone
    const sign = clone.querySelector("#signImg");
    if (sign && !sign.complete) {
      await new Promise(res => { sign.onload = res; sign.onerror = res; });
    }
    const pending = Array.from(clone.querySelectorAll("img"))
      .filter(img => !img.complete || img.naturalWidth === 0)
      .map(img => img.decode ? img.decode().catch(()=>{}) : Promise.resolve());
    await Promise.all(pending);

    // Capture with a white background
    const canvas = await html2canvas(clone, {
      scale: 2,
      backgroundColor: "#fff",
      useCORS: true
    });

    const img = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p","mm","a4");        // always A4
    const w = pdf.internal.pageSize.getWidth();  // 210mm
    const h = pdf.internal.pageSize.getHeight(); // 297mm

    // Paint a white page first (kills any viewer black)
    pdf.setFillColor(255,255,255);
    pdf.rect(0,0,w,h,"F");

    // Cover full page with the image
    pdf.addImage(img, "PNG", 0, 0, w, h);

    const fileName = (document.getElementById("invoiceNoText").textContent || "CC") + ".pdf";
    pdf.save(`Invoice_${fileName}`);

    holder.remove(); // cleanup
  });
</script>
</body>
</html>

